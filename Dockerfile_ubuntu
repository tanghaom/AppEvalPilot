FROM kasmweb/core-ubuntu-jammy:1.18.0

# Use root for system setup; Kasm images expect this during build
USER root

# Kasm envs and working dirs
ENV HOME=/home/kasm-default-profile
ENV STARTUPDIR=/dockerstartup
ENV INST_SCRIPTS=$STARTUPDIR/install
WORKDIR $HOME

######### System Dependencies ###########
# Notes:
# - Keep apt clean to reduce layer size
# - Include AT-SPI stack for Linux UI accessibility (pyatspi)
# - Include tools for screenshots/clipboard, adb for Android control, and common CV libs

RUN apt-get update \
    && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
        sudo \
        ca-certificates \
        curl \
        git \
        python3 \
        python3-dev \
        python3-pip \
        python3-venv \
        python3-tk \
        python3-pyatspi \
        at-spi2-core \
        libatk1.0-0 \
        libatk-bridge2.0-0 \
        libatspi2.0-0 \
        gir1.2-atspi-2.0 \
        gnome-screenshot \
        xclip \
        xdg-utils \
        adb \
        ffmpeg \
        libsm6 \
        libxext6 \
        libgl1 \
        libglib2.0-0 \
        libgtk-3-0 \
        pkg-config \
        build-essential \
        wget \
        xz-utils \
        libdbus-glib-1-2 \
        libasound2 \
        orca \
    && rm -rf /var/lib/apt/lists/* /var/cache/apt/archives/*

RUN wget --no-check-certificate -O /tmp/firefox.tar.xz "https://download-installer.cdn.mozilla.net/pub/firefox/releases/143.0.4/linux-x86_64/zh-CN/firefox-143.0.4.tar.xz" \
    && tar -xvf /tmp/firefox.tar.xz -C /opt/ \
    && ln -s /opt/firefox/firefox /usr/bin/firefox \
    && rm /tmp/firefox.tar.xz

# Passwordless sudo for kasm-user
RUN echo 'kasm-user ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers

######### Copy project ###########
WORKDIR /workspace/AppEvalPilot
COPY . /workspace/AppEvalPilot

######### Virtualenv + Python Dependencies ###########
# Create venv (with system site packages per README), install deps into venv via pip
ARG ENABLE_ULTRA=0
RUN set -eux; \
    python3 -m venv /workspace/AppEvalPilot/venv --system-site-packages; \
    . /workspace/AppEvalPilot/venv/bin/activate; \
    pip install --no-cache-dir --upgrade pip setuptools wheel uv; \
    uv pip install --no-cache-dir -r requirements.txt; \
    uv pip install --no-cache-dir -e .; \
    if [ "$ENABLE_ULTRA" = "1" ]; then \
      uv pip install --no-cache-dir -e .[ultra]; \
    fi; \
    deactivate; \
    chown -R 1000:0 /workspace

# Expose venv by default for all users
ENV VIRTUAL_ENV=/workspace/AppEvalPilot/venv
ENV PATH=$VIRTUAL_ENV/bin:$PATH

# Enable GTK accessibility and AT-SPI bridge
ENV GTK_MODULES=gail:atk-bridge
ENV NO_AT_BRIDGE=0
ENV ACCESSIBILITY_ENABLED=1

######### Kasm Desktop Integration ###########
# Ensure Kasm user owns their home
RUN chown 1000:0 $HOME \
    && $STARTUPDIR/set_user_permission.sh $HOME

# Switch to runtime user expected by Kasm
ENV HOME=/home/kasm-user
WORKDIR $HOME
RUN mkdir -p $HOME && chown -R 1000:0 $HOME

# Create autostart directory and orca autostart configuration
RUN mkdir -p $HOME/.config/autostart \
    && echo '[Desktop Entry]\n\
Type=Application\n\
Name=Orca Screen Reader\n\
Comment=Start Orca accessibility service\n\
Exec=/usr/bin/orca --no-setup --disable splash-window &\n\
Terminal=false\n\
Categories=Accessibility;\n\
X-GNOME-Autostart-enabled=true\n\
StartupNotify=false' > $HOME/.config/autostart/orca.desktop \
    && chmod +x $HOME/.config/autostart/orca.desktop \
    && chown -R 1000:0 $HOME/.config

USER 1000

######### Defaults ###########
# Set a default working directory for user sessions
WORKDIR /workspace/AppEvalPilot

# You can override command via docker run; Kasm base handles desktop/VNC startup